<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
	<meta http-equiv="x-ua-compatible" content="ie=edge">
	<link rel="stylesheet" href="css/jquery-ui.min.css"></link>
	<script src="lib/jquery.min.js"></script>
	<script src="lib/jquery-ui.min.js"></script>
	<link REL="SHORTCUT ICON" HREF="img/favicon.ico">
	<title>CTScan</title>
	<style type="text/css">
		 body { 			font-family: Verdana,Geneva,sans-serif; font-size:13px; box-sizing: border-box;
							padding: 0px; margin: 0px; 
							}
		.ct-splash { 		position: absolute; top:50px; left: calc(50% - 200px); opacity:0; width: 400px;
							font-size: 20px; text-align: center; font-weight: bold;
							}
		.ct-obsPanel {		background-color:#ddd; border-radius: 6px; margin: 24px; padding: 12px; width: 618px;
							margin-left: auto; margin-right: auto; opacity: 0; display: none;
							}
		.ct-obsCat {		font-size: 20px; font-weight: bold; color: #333; margin-bottom: 4px;
							display: inline-block; user-select: none; 
							}
		.ct-obsTime {		font-size: 20px; border-radius: 6px; background-color: #fff; text-align: center; width: 110px; float: right;
							border: 1px solid #ccc; color: #666; user-select: none; margin-bottom: 8px;
							}
		.ct-obsStart {		cursor: pointer; width: 14px; margin-left: 8px; margin-right: 8px; float:right; margin-top: 3px;
							}
		.ct-obsPrac {		cursor: pointer; vertical-align: -6px; margin-left: 67px; 
							}
		.ct-obsPracText {	font-size: 12px; color:#000; font-weight: bold; margin-bottom: 8px; 
							user-select: none;
							}
		.ct-obsNewPrac {	cursor: pointer; color:#fff; 
							text-align: center; border-radius: 6px; display: inline-block; user-select: none;
							font-size: 12px; background-color: #27ae60; padding: 2px 8px 2px 8px; vertical-align:3px;
							}
		.ct-obsPracList {	font-size: 13px; user-select: none; overflow-x:hidden; overflow-y: auto; height: 100%
							}
		.ct-obsPracItem {	cursor: pointer; padding:1px;
							}
		.ct-obsPracItem:hover {	 background-color:#ccc;
							}
		.ct-obsPracSubs	{ 	width: 250px; font-weight: normal; cursor: pointer; display: inline-block; color:#666;
							margin-left: 25px;
							}
		.ct-obsDone {		cursor: pointer; color:#fff; text-align: center; border-radius: 6px; display: inline-block; user-select: none;
							font-size: 12px; background-color:#e74c3c; padding: 2px 8px 2px 8px;
							}
		.ct-obsEvtBut {		width: 80px; height: 60px;  margin-bottom: 8px; cursor: pointer; color:#fff; 
							text-align: center; border-radius: 6px; display: inline-block; user-select: none;
							padding-top:8px; font-size: 14px; margin-right:4px; background-color:#aaa;
							}
		.ct-obsEvtBut:hover { opacity : .75
							}
		.ct-count {			cursor: zoom-out;
							}
		.ct-count:hover {	color: #333;
							}
		.ct-mediarow {		width:280px;
							}
		.ct-mediaNotes 	{	margin-top: 8px; margin-bottom: 6px; user-select: none;
							}
		.ct-notes 	{		width: 560px; border-radius:4px; padding-left:8px; border: 1px solid #999;
		 					margin-top: 8px; margin-bottom: 6px;
							}
		.ct-notesBut {		cursor: pointer; color:#fff; text-align: center; border-radius: 6px; display: inline-block;
							margin-top: 2px; margin-left:4px; user-select: none; font-size: 10px; 
							padding-bottom: 2px; padding-left: 6px; padding-right: 6px; background-color:#27ae60
							}
		.ct-dataPanel {		border-radius: 6px; background-color:#eee;padding: 12px; max-width: 600px; margin-left: auto; margin-right: auto; max-height:400px;
							overflow-x:hidden; overflow-y:auto;
							}
		.ct-is 	{			border-radius:4px; padding-left:8px; border: 1px solid #999; margin-bottom: 3px;
							}

		.ct-popup {			display: none; position: absolute; padding: 3px 8px 3px 8px; border-radius: 6px;
							font-size: 11px; border: 1px solid #e74c3c; background-color: #eee;
							}
		.ct-dialogTitle {	font-size: 20px; font-weight: bold; color: #000; margin-bottom: 8px; user-select: none;
							}
		.unselectable { 	-moz-user-select: none;     -khtml-user-select: none;
		   			 		-webkit-user-select: none;  -ms-user-select: none;   user-select: none;
		   				}
		@media only screen and (max-height: 525px) {	.ct-obsPanel {	margin-top: 0; margin-bottom: 0   }		}

		.ui-dialog-buttonpane.ui-widget-content.ui-helper-clearfix { border:none }
		.ui-dialog { border-radius:6px; background-color:#eee; }
		.ui-button { border-radius:30px;outline:none }
		.ui-dialog-titlebar { display:none }
		 table {			border-spacing: 0px;  }
		 input {		    vertical-align: -2px; }

</style>
</head>
<body>
	<div id="splashDiv" class="ct-splash">
		<img src="img/ctlogo400.png" width="200"><br><br>
		Classroom Teaching<br>Scan<br><br>
		<div style="font-size:14px;font-weight:normal">
			Michael J. Kennedy<br>Wendy J. Rodgers, and John E. Romig<br><br>
			<b>Curry School of Education<br>University of Virginia</b>
			<br>&copy; 2017<br><br>
			<div id="startIt" class="ct-obsNewPrac">Click to continue</div><br><br>
 			<p style="font-size:12px;line-height:130%">
			Thank you to our colleagues who provided guidance,<br>helped develop, and/or piloted the CT Scan:<br><br>
				Bill Gressick, Barron Associates (www.barron-associates.com), Kat D. Alves, Longwood University, 
				John Wills Lloyd, University of Virginia, Hannah Morris Mathews, University of Virginia, Peggy Weiss, George Mason University, Mary Brownell, University of Florida,  
				Bill Ferster, University of Virginia.
				<br><br>v2.0
				</p>
		</div>
	</div>
	<div id="obsPanel" class="ct-obsPanel">
		<div id="obsNewCat"  class="ct-obsNewPrac">Set</div>
		<div id="obsCat" class="ct-obsCat">No category chosen yet...</div>&nbsp;&nbsp;
		<div id="obsTimerText" class="ct-obsTime">00:00</div>
		<img id="obsStart" src="img/playbut.png" class="ct-obsStart">
		<div class="ct-obsPracText" id="obsPracText" ></div><div id="obsNewPrac" class="ct-obsNewPrac">Set new practice</div>&nbsp;&nbsp;
		<div id="obsConfirmPrac" class="ct-obsNewPrac" style="display:none">Confirm</div><br>
		<hr style="margin-bottom:8px;margin-top:10px">
		Add Vocab Term or Topic: <input class="ct-is" id="newTerm" type="text" placeholder="Type new term here"></input>	
		<div id="sendTerm" class="ct-notesBut">Add</div>
		<div id="vocabTerms"></div>
		<hr style="margin-bottom:8px">
		<div>
			<div id="ev-1" class="ct-obsEvtBut"><span id="evl-1"></span><span class="ct-count" id="evc-1"><br></span></div> 
			<div id="ev-2" class="ct-obsEvtBut"><span id="evl-2"></span><span class="ct-count" id="evc-2"><br></span></div> 
			<div id="ev-3" class="ct-obsEvtBut"><span id="evl-3"></span><span class="ct-count" id="evc-3"><br></span></div> 
			<div id="ev-4" class="ct-obsEvtBut"><span id="evl-4"></span><span class="ct-count" id="evc-4"><br></span></div>
			<div id="ev-5" class="ct-obsEvtBut"><span id="evl-5"></span><span class="ct-count" id="evc-5"><br></span></div> 
			<div id="ev-6" class="ct-obsEvtBut"><span id="evl-6"></span><span class="ct-count" id="evc-6"><br></span></div>
			<div id="ev-7" class="ct-obsEvtBut"><span id="evl-7"></span><span class="ct-count" id="evc-7"><br></span></div><br> 
			<div id="ev-8" class="ct-obsEvtBut"><span id="evl-8"></span><span class="ct-count" id="evc-8"><br></span></div> 
			<div id="ev-9" class="ct-obsEvtBut"><span id="evl-9"></span><span class="ct-count" id="evc-9"><br></span></div> 
			<div id="ev-10" class="ct-obsEvtBut"><span id="evl-10"></span><span class="ct-count" id="evc-10"><br></span></div> 
			<div id="ev-11" class="ct-obsEvtBut"><span id="evl-11"></span><span class="ct-count" id="evc-11"><br></span></div> 
			<div id="ev-12" class="ct-obsEvtBut"><span id="evl-12"></span><span class="ct-count" id="evc-12"><br></span></div> 
			<div id="ev-13" class="ct-obsEvtBut"><span id="evl-13"></span><span class="ct-count" id="evc-13"><br></span></div> 
			<div id="ev-14" class="ct-obsEvtBut"><span id="evl-14"></span><span class="ct-count" id="evc-14"><br></span></div> 
		</div>
		<hr style="margin-bottom:8px;margin-top:2px">
		<table style="margin-top:4px">
			<tr><td class="ct-mediarow"><input id="md-1" type="checkbox"> <span id="ml-1">Diagram/Graph</span></input></td>
			<td class="ct-mediarow"><input id="md-2" type="checkbox"> <span id="ml-2">Object/Manipulative</span></input></td>
			<td class="ct-mediarow"><input id="md-3" type="checkbox"> <span id="ml-3">Graphic Organizer</span></input></td></tr>
			<tr><td><input id="md-4" type="checkbox"> <span id="ml-4">Picture</span></input></td><td><input id="md-5" type="checkbox"> <span id="ml-5">Movie</span></input></td>
			<td><input id="md-6" type="checkbox"> <span id="ml-6">Text</span></input></td></tr>
		</table><hr>
		Teacher: <select select id="whichTeacher" class="ct-is" ><option/><option>General</option><option>Special Ed</option><option>Para/IA</option></select>
		&nbsp;&nbsp;Grouping: &nbsp;<select id="teacherTalk" class="ct-is"><option/><option>Whole group</option><option>Small group</option>
		<option>Individual</option><option>Other adult</option><option>No one</option></select>&nbsp;&nbsp;
		Co-teaching?&nbsp;&nbsp;<select id="teacherModel" class="ct-is"><option/><option>NONE</option><option>Alternative</option>
		<option>1-teach/1-observe</option><option>1-teach/1-assist</option><option>Parallel</option><option>Stations</option><option>Team</option></select>
		<hr>
		Student actions:&nbsp;&nbsp;<select id="studentAction" class="ct-is"><option/></select>
		<textarea id="obsNote" class="ct-notes" type="text" placeholder="Type new note here"></textarea>
		<div style="margin-top:8px;font-size:10px;float:right">
			<div id="obsNoteOops" class="ct-notesBut" style="background-color:#e67e22;margin-bottom:3px">Oops</div><br>
			<div id="obsNoteSend" class="ct-notesBut">Send</div>
		</div>
		<hr style="margin-bottom:12px;margin-top:4px">
		<div id="obsDone" class="ct-obsDone">Done</div>
		<span style="float:right;color:#666">Help&nbsp;<a style="float:right" href="https://docs.google.com/document/d/19l87L5sZfLohU6rhQKLMERTNHhQr-jLiE4xQJeYN_3g/edit?usp=sharing" target="_blank">
		<img src="img/helpicon.gif" style="vertical-align:bottom" title="Show help"></a></span><br>
	</div> <!-- ObsPanel --> 
	<div id="popup" class="ct-popup"></div>

<script>

//////////////////////////////////////////////////////////////////////////////////////////////////
// MAIN 
/////////////////////////////////////////////////////////////////////////////////////////////////

var curTime=0;															// Saves time in task
var timingInterval=null,totInterval=null;								// Timing interval
var totTiming=0;														// Time on task timing
var inPlay=false;														// Play flag
var curCat=-1;curPrac=-1;												// Current category, practice
var vocabTopicTerms=[];													// Holds vocab/topic terms
var kidsInClass=0;														// Number of kids in class
var pracTime;															// When practice was set

var menus=[];															// Holds menus
var dataMedia=[];														// Holds media buttons											
var dataLabs=[];														// Holds OTR button labels											
var dataLabVals=[];														// Holds OTR button values											
var dataLabCats=[];														// Holds OTR button categories											
var dataLabCols=[];														// Holds OTR button colors											
var dataActs=[];														// Holds media buttons											
var dataAcad=[];														// Holds academic diciplines

var obsEvents=[];														// Holds events										
var obsData={};															// Obs info
var assessData=[];														// Hold assessments
var assessNum=1;														// Save asssess number

$(document).ready(function() {								           	// ON PAGE LOADED
	var menu="menus.txt";												// Default menu
	var url=window.location.search.substring(1);						// Get query string
	if (url) {															// If something on command line
		menu=url;														// Get name
		if (!menu.match(/\.txt/))	menu+=".txt";						// Add ext if not there
		}
	$.ajax({ type: "GET", url: menu, success: function(text) {			// Get menus text tile
		var i,j,o,cp,cc,subs;
		text=text.replace(/\n\r/g,"\n");								// LFCR -> LF
		text=text.replace(/\r\n/g,"\n");								// CRLF -> LF
		text=text.replace(/\r/g,"");									// Remove CR
		var lines=text.split("\n");										// Spit by line
		for (i=0;i<lines.length;++i) {									// For each line
			o=lines[i];													// Point at line
			if (!o)	continue;											// Skip blanks
			if (o.match(/MEDIA=/i)) 									// Media button
				dataMedia=o.substr(6).split(",");						// Get options
			else if (o.match(/BUTVAL=/i)) 								// OTR button value
				dataLabVals=o.substr(7).split(",");						// Get options
			else if (o.match(/BUTLAB=/i)) 								// OTR button label
				dataLabs=o.substr(7).split(",");						// Get options
			else if (o.match(/BUTCAT=/i)) 								// OTR button category
				dataLabCats=o.substr(7).split(",");						// Get options
			else if (o.match(/BUTCOL=/i)) 								// OTR button color
				dataLabCols=o.substr(7).split(",");						// Get options
			else if (o.match(/STUACT=/i)) 								// Student actions
				dataActs=o.substr(7).split(",");						// Get options
			else if (o.match(/ACAD=/i)) 								// Disciplines
				dataAcad=o.substr(5).split(",");						// Get options
			else if (o.match(/ASSESS=/i)) 								// Assessment
				assessData.push(o);										// Get pages
			else if (o.match(/:/)) {									// At new category
				cc=menus.length;										// Get index
				menus.push({});											// Add cat obj
				menus[cc].cname=o.substr(0,o.length-1);					// Add cat name
				menus[cc].prac=[];										// Add array for practices									
				}
			else if (o.match(/\*/)) {									// At new * category
				cp=menus[cc].prac.length;								// Get prac index
				menus[cc].prac.push({});								// Add practice obj
				menus[cc].prac[cp].pname=o.split(" *")[0];				// Add prac name
				menus[cc].prac[cp].subs=[];								// Add array for sub-practices									
				subs=o.split("&")[1].split(",");						// Get subs, if any
				for (j=0;j<subs.length;++j)								// For each sub
					if (subs[j].length)									// If something there
						menus[cc].prac[cp].subs.push(subs[j]);			// Add to practice
				}
			}
			
		if (window.addEventListener) 									// If listener supported this way
			window.addEventListener("message",QmediaEventHandler,false);// Add event handler
		else															// Use other method
			window.attachEvent("message",QmediaEventHandler);			// Add handler

		}});

	$("#startIt").on("click", function() {								// ON START CLICK
		$("#splashDiv").animate({ opacity:0 },400);						// Hide logo
		$("#obsPanel").show();											// Show main screen
		GetIntroData();													// Get intro data from user
		$("#obsPanel").animate({ opacity:1}, 500, function() {			// Show interface
			$("#splashDiv").hide();										// Hide splash
			InitObs();													// Init observation screen
			});
		})

	$("#obsDone").on("click", function() {								// ON DONE
		if (ConfirmBox("This will end the observation session",			// Are you sure?
			function() {												// If sure
				if (assessData.length)									// If any additional assessmentd
					Assess();											// Run them
				else													// None
					DonePanel();										// We're done
				}));							
			});

	$("#splashDiv").animate({ opacity:1 },1000);						// Show logo
	});																	// End onReady()		


///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
// SETUP
///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

function GetIntroData()												// GET INTRO DATA FROM USER
{
	var str="<table>";
	str+="<tr><td>Teacher&nbsp;ID:</td><td><input class='ct-is' id='intro-id' type='Text'></input></td></tr>";
	str+="<tr><td>Observer&nbsp;name:</td><td><input class='ct-is' id='intro-name' type='Text'></input></td></tr>";
	str+="<tr><td>Observer&nbsp;email:</td><td><input class='ct-is' id='intro-email' type='Text'></input></td></tr>";
	str+="<tr><td>Grade:</td><td><select id='intro-grade' class='ct-is'>";
	str+="<option>K</option><option>1</option><option>2</option><option>3</option><option>4</option>";
	str+="<option>5</option><option>6</option><option>7</option><option>8</option><option>9</option>";
	str+="<option>10</option><option>11</option><option>12</option></select></td></tr>";
	str+="<tr><td>Academic content:</td><td><select id='intro-sub' class='ct-is'><select>";
	str+="<tr><td>Number&nbsp;of&nbsp;students:&nbsp;&nbsp;</td><td><input class='ct-is' id='intro-numkids' type='Text'></input></td></tr>";
	str+="<tr><td>Date:</td><td><input class='ct-is' id='intro-date' type='date'></td></tr>";
	str+="<tr><td>Block/Time:</td><td><input class='ct-is' id='intro-block' type='text'></td></tr>";
	str+="<tr><td>Instructional setting:</td><td><select id='intro-setting' class='ct-is'><option>Self-contained (Academic)</option><option>Self-contained (Severe/Profound)</option>";
	str+="<option>Co-taught</option><option>Inclusive</option><option>General Education only</option></select></td></tr>";
	str+="<tr><td>Teacher level:</td><td><select id='intro-level' class='ct-is'><option>Preservice Teacher</option><option>Inservice Teacher</option></select></td></tr>";
	str+="<tr><td>Video&nbsp;source:</td><td><input class='ct-is' id='intro-video' placeholder='URL of video, if not live' type='Text'></input></td></tr>";
	str+="<tr><td>Research only:</td><td><select id='intro-res' class='ct-is'><option></option><option>Pre-Intervention</option>";
	str+="<option>Post-Intervention</option><option>Maintenance</option></select></td></tr>";
	str+="<tr><td>Remind&nbsp;every:</td><td><select id='intro-tot' class='ct-is'>";
	str+="<option>0</option><option>.5</option><option>1</option><option>1.5</option><option selected>2</option><option>5</option><option>10</option></select> min(s) students on task</td></tr>";
	str+="</table><br>"
	str+="<div style='float:right'> Help <a href='https://docs.google.com/document/d/19l87L5sZfLohU6rhQKLMERTNHhQr-jLiE4xQJeYN_3g/edit?usp=sharing' target='_blank'>";
	str+="<img src='img/helpicon.gif' style='vertical-align:bottom' title='Show help'></a></div>";
	
	DialogBox("Setup",str, function() {									// Run dialog
		obsData.tid=$("#intro-id").val();
		obsData.name=$("#intro-name").val();
		obsData.email=$("#intro-email").val();
		obsData.grade=$("#intro-grade").val();
		obsData.subject=$("#intro-sub").val();
		obsData.number=$("#intro-numkids").val();
		obsData.date=$("#intro-date").val();
		obsData.block=$("#intro-block").val();
		obsData.setting=$("#intro-setting").val();
		obsData.level=$("#intro-level").val();
		obsData.video=($("#intro-video").val() ? $("#intro-video").val() : "Live");
		obsData.remind=$("#intro-tot").val();
		obsData.research=$("#intro-res").val();
		totTiming=$("#intro-tot").val();
	
		if ($("#intro-numkids").val()) 								// If num kids set
			kidsInClass=isNaN($("#intro-numkids").val()) ? 0 : $("#intro-numkids").val()-0;	// Set it
		});

	Date.prototype.toDateInputValue = (function() {
    	var local = new Date(this);
    	local.setMinutes(this.getMinutes() - this.getTimezoneOffset());
   		return local.toJSON().slice(0,10);
		});
	$('#intro-date').val(new Date().toDateInputValue());

	for (i=0;i<dataAcad.length;++i)
		$("#intro-sub").append("<option>"+dataAcad[i]+"</option>");

	for (i=0;i<menus.length;++i)
		$("#intro-cat").append("<option>"+menus[i].cname+"</option>");
}

function InitObs() 													// INIT OBSERVATION PANEL
{
	var i,j;
	for (i=1;i<=dataMedia.length;++i) {									// For each media
		$("#ml-"+i).text(dataMedia[i-1]) 								// Set label
	
		$("#md-"+i).on("click", function(e) {							// On box click
			var col="#000",wgt="normal";								// Def style
			var id=e.currentTarget.id.substr(3);						// Get id			
			if ($(this).prop("checked")) {								// Activating
				col="#009900",wgt="bold";								// Make it bold green
				SaveEvent(curTime,"Visual Aid",dataMedia[id-1],"","",0);	// Save event
				}
			else{														// Deactivating
				for (j=obsEvents.length-1;j>=0;--j) {					// Search backwards
					if (obsEvents[j].d2 == dataMedia[id-1]) {			// Found last
						obsEvents[j].d5=curTime-obsEvents[j].time;		// Add time	
						trace("---> "+dataMedia[id-1]+" STOPPED at "+obsEvents[j].d5+" <----"); 
						break;											// Quit looking
						}
					}
				}
			$("#ml-"+id).css({ "color":col, "font-weight":wgt});		// Style
			});
		}
	for (i=0;i<dataActs.length;++i) 									// For each student action
		$("#studentAction").append("<option>"+dataActs[i]+"</option>");	// Add option

	for (i=1;i<=dataLabs.length;++i) {									// For each event button
		$("#evl-"+i).html(dataLabs[i-1]+"<br>");						// Set label
		$("#ev-"+i).css("background-color",dataLabCols[i-1]);			// Set back color

		$("#ev-"+i).on("click", function(e) {							// On event button click
			var id=e.currentTarget.id.substr(3);						// Get id			
			var c=1;													// First one												
			var s=$("#evc-"+id).text();									// Get count from label
			if (s)	c=s.substr(1,s.length-2)-0+1						// If not first, get and increment
			$("#evc-"+id).html("("+c+")");								// Show new count
			Sound("click");												// Click sound	
			SaveEvent(curTime,"Event",dataLabCats[id-1],dataLabVals[id-1],c);	// Save event
			});

		$("#evc-"+i).on("click", function(e) {							// ON EVENT CLICK
			var j;
			e.stopPropagation();										// Stop propagation
			var id=e.currentTarget.id.substr(4);						// Get id			
			for (j=obsEvents.length-1;j>=0;--j) {						// Search backwards
				if (obsEvents[j].d2 == dataLabVals[id-1]) {				// Found last
					obsEvents.splice(j,1);								// Remove it from list
					trace("---> REMOVED OTR <----");					// Removed
					break;												// Quit looking
					}
				}
			var s=$("#evc-"+id).text();									// Get count from label
			var c=s.substr(1,s.length-2)-1								// If not first, get and decrement
			if (c)														// Something to show
				$("#evc-"+id).html("("+c+")");							// Show new count
			else														// No counts
				$("#evc-"+id).html("<br>");								// Clear display
			Sound("delete");											// Delete sound	
			});
		}

	$("#obsStart").on("click", function(e) {							// START/STOP TIMER
		inPlay=!inPlay;													// Toggle state
		SetPlayMode(inPlay);											// Set play mode
		});
	
	$("#obsNoteSend").on("click", function(e) {							// ON NOTE SEND
		if (!$("#obsNote").val())										// If no value
			return;														// Quit
		SaveEvent(curTime,"Note",$("#obsNote").val());					// Save event
		$("#obsNote").val("");											// Clear textarea
		Sound("click");													// Click sound	
		});

	$("#obsNoteOops").on("click", function(e) {							// ON OOPS SEND
		if (!$("#obsNote").val())										// If no value
			return;														// Quit
		SaveEvent(curTime,"Note","!! OOPS !! "+$("#obsNote").val());	// Save event
		$("#obsNote").val("");											// Clear textarea
		Sound("click");													// Click sound	
		});

	$("#obsNewCat").on("click", function(e) {							// ON CHANGE CATEGORY
		var i;
		$("#alertBoxDiv").remove();										// Remove any old ones
		$("body").append("<div class='qm-unselectable' id='alertBoxDiv'></div>");														
		var str="<p><img src='img/ctlogo32.png' style='vertical-align:-8px'/>&nbsp;&nbsp;";								
		str+="<span class='ct-dialogTitle'>Choose a category</span><p>";
		str+="<div style='font-size:12px;margin:14px'>";
		str+="<div id='pracList' class='ct-obsPracList'>";				// List holder
		for (i=0;i<menus.length;++i)									// For each category
			str+="<div id='cat-"+i+"'class='ct-obsPracItem'>"+menus[i].cname+"</div>";	// Add title
			str+="</div>";
		$("#alertBoxDiv").append(str);	
		$("#alertBoxDiv").dialog({ 	 width:$("#obsPanel").width()+16, height:$("#obsPanel").height()+24 });	
		$("#alertBoxDiv").dialog("option","position",{ my:"middle", at:"middle", of:obsPanel });
		
		$("[id^=cat-]").on("click", function(e) {						// ON CATEGORY CHOOSE		
			curCat=e.currentTarget.id.substr(4);						// Get id			
			$("#obsCat").text(menus[curCat].cname);						// Show new name
			$("#alertBoxDiv").remove();  								// Close it
			$("#obsPracText").html("");									// Remove practices
			Sound("click");												// Click sound	
			});
		});

	$("#obsNewPrac").on("click", function(e) {							// ADD NEW PRACTICE
		var i;
		if (curCat < 0)													// Not category yet											
			return;														// Quit
		$("#alertBoxDiv").remove();										// Remove any old ones			
		$("body").append("<div class='qm-unselectable' id='alertBoxDiv'></div>");														
		var str="<p><img src='img/ctlogo32.png' style='vertical-align:-8px'/>&nbsp;&nbsp;";								
		str+="<span class='ct-dialogTitle'>Choose a practice</span><p>";
		str+="<div style='font-size:12px;margin:14px'>";
		str+="<div id='pracList' class='ct-obsPracList'>";				// List holder
		for (i=0;i<menus[curCat].prac.length;++i)	{					// For each practice
			var title=menus[curCat].prac[i].pname;						// Extract title
			str+="<div id='opl-"+i+"'class='ct-obsPracItem'>"+title+"</div>";	// Add title
			}
		$("#alertBoxDiv").append(str);	
		$("#alertBoxDiv").dialog({ 	 width:$("#obsPanel").width()+16, height:$("#obsPanel").height()+24 });	
		$("#alertBoxDiv").dialog("option","position",{ my:"middle", at:"middle", of:obsPanel });
		
		$("[id^=opl-]").on("click", function(e) {						// On choosing one		
			var str="";			
			var id=e.currentTarget.id.substr(4);						// Get id			
			curPrac=id;													// Set current practice
			$("#obsConfirmPrac").css("display","inline-block");			// Hide
			pracTime=curTime;											// Save time
			str+="<div style='display:inline-block;margin-bottom:4px;margin-top:4px'>"+menus[curCat].prac[curPrac].pname+"</div><br>";
			str+="<div id='0' class='ct-obsPracSubs'>&bull;&nbsp;None</div>";
			for (i=0;i<menus[curCat].prac[id].subs.length;++i) {
				str+="<div id='"+(i+1)+"'";
				str+="' class='ct-obsPracSubs'>&bull;&nbsp;"+menus[curCat].prac[id].subs[i]+"</div>";
				}
		str+="<br>";
		$("#obsPracText").html(str);
		
		$(".ct-obsPracSubs").on("click", function(e) {					// CLICK ON PRACTICE SUB
				if ($("#obsConfirmPrac").css("display") != "none") {	// If not confirmed yet
					Sound("delete");									// Delete sound
					ShowPopup(e.clientX+16,e.clientY+16,"Please confirm practice first!");
					return;
					}												// Quit
				var id=e.currentTarget.id-1;							// Get id			
				var sub=menus[curCat].prac[curPrac].subs[id];			// Get sub
				var n=menus[curCat].prac[curPrac].subs.length;			// Number of subs
				sub=sub ? sub : "";										// If undefines, null
				if ($(this).css("font-weight") == "bold") {				// Already set
					Sound("delete");									// Delete sound	
					$(this).css({ color:"#000","font-weight":"normal"});// Un-highlight it
					for (var j=obsEvents.length-1;j>=0;--j) {			// Search backwards
						if ((obsEvents[j].d3 == menus[curCat].prac[curPrac].pname) && (obsEvents[j].d4 == sub)) {	// Found last
							obsEvents.splice(j,1);						// Remove it from list
							trace("---> REMOVED sub-practice <----");	// Removed
							return;										// Quit
							}
						}
					}
			$(this).css({ color:"#009900","font-weight":"bold"});	// Highlight it
			SaveEvent(curTime,"Teacher actions",menus[curCat].cname,menus[curCat].prac[curPrac].pname,sub,n);	// Save event
			Sound("click");											// Click sound	
			});

			$("#alertBoxDiv").remove();  								// Close it
			Sound("click");												// Click sound	
			});
		});

	$("#obsConfirmPrac").on("click", function(e) {						// CONFIRM PRACTICE
		var j;
		if ((curCat < 0) || (curPrac < 0))								// No category and practice yet											
			return;														// Quit
		SaveEvent(pracTime,"Practice",menus[curCat].cname,menus[curCat].prac[curPrac].pname);	// Save event
		$(this).css("display","none");									// Hide
		Sound("click");													// Click sound	
		});

	$("#studentAction").on("change", function(e) {						// STUDENT ACTION
		SaveEvent(curTime,"Student actions",$(this).val());				// Send event
		Sound("click");													// Click sound	
		});													

	$("#teacherTalk").on("change", function(e) {						// ON WHICH TALKING
		SaveEvent(curTime,"Teacher status","Grouping",$(this).val());	// Send event		
		Sound("click");													// Click sound	
		});													

	$("#whichTeacher").on("change", function(e) {						// ON WHICH TEACHER
		SaveEvent(curTime,"Teacher status","Which Teacher",$(this).val()); 	// Send event		
		Sound("click");													// Click sound	
		});													

	$("#teacherModel").on("change", function(e) {						// ON TEACHER MODEL
		SaveEvent(curTime,"Teacher status","Model",$(this).val()); 		// Send event		
		Sound("click");													// Click sound	
		});													

	$("#newTerm").on("keypress", function(e) {							// ENTER HIT FOR NEW TERM
		if (e.which == 13)												// Enter key hit
			$("#sendTerm").trigger("click");							// Simulate save click
		});													
	
	$("#sendTerm").on("click", function(e) {							// ON SAVE TERM														
		if (!$("#newTerm").val())										// Nothing there						
			return;														// Quit
		Sound("click");													// Click sound	
		SaveEvent(curTime,"Vocab Word",$("#newTerm").val(),"");			// Save term
		vocabTopicTerms.push($("#newTerm").val());						// Add to list
		$("#newTerm").val("");											// Clear
		fillTermList();													// Fill term list
		});

		function fillTermList() {										// FILL TERM LIST									
			var i;
			var str="Active term(s) or topic(s) <i>(click to remove): </i>";// Header			
			for (i=0;i<vocabTopicTerms.length;++i) 	{					// For each term
				if (i)	str+=", ";										// Add separator
				str+="<span id='termItem-"+i+"' style='cursor:zoom-out;color:#009900'><b>"+vocabTopicTerms[i]+"</b></span>";	// Add term
				}
			$("#vocabTerms").html(str);									// Show all terms
			
			$("[id^=termItem-]").on("click", function(e) {				// On click of item		
				var id=e.currentTarget.id.substr(9);					// Get id			
				var str=$("#termItem-"+id).text();						// Get word
				for (j=obsEvents.length-1;j>=0;--j) {					// Search backwards
					if (obsEvents[j].d2 == str) {						// Found last
						obsEvents[j].d5=curTime-obsEvents[j].time;		// Add time	
						trace("---> "+str+" STOPPED at "+obsEvents[j].d5+" <----"); 
						break;											// Quit looking
						}
					}
				vocabTopicTerms.splice(id,1);							// Remove it
				Sound("delete");										// Delete sound	
				fillTermList();											// Fill term list
				});
			}
	}

	function SetPlayMode(mode) {
		if (inPlay)	{
			$("#obsStart").prop("src","img/pausebut.png");				// Pause but		
			Sound("click");												// Click sound	
			SetTimer("start");											// Start timer
			}
		else{		
			$("#obsStart").prop("src","img/playbut.png");				// Play but		
			Sound("delete");											// Delete sound	
			SetTimer("pause");											// Stop timer
			}
		}

	function SetTimer(mode) {
		clearInterval(timingInterval);									// Clear timer
		clearInterval(totInterval);										// Clear tot timer

		if ((totTiming > 0) && inPlay)									// If tot time set and playing
			totInterval=setInterval( function() {						// Start tot timer
					GetTimeOnTask();									// Payload
					},totTiming*60000);									// Set time

		inPlay=false;													// Not in play
		if (mode == "start") {											// Timing
			inPlay=true;												// In play
			timingInterval=setInterval(function() {						// Start timer
				showTime(++curTime);									// Add to count and show
				} ,1000);												// 1fps
			}
		else if (mode == "reset")										// Reset
			curTime=0;													// To 0
	
		function showTime(time) {										// DISPLAY CURRENT TIME
			var secs=time%60;											// Get secs
			if (secs == 0)		secs="00";								// Double 0
			else if (secs < 10) secs="0"+secs;							// Add leading 0
			var mins=Math.floor(time/60);								// Get mins
			if (mins == 0)		mins="00";								// Double 0
			else if (mins < 10) mins="0"+mins;							// Add leading 0
			$("#obsTimerText").text(mins+":"+secs);						// Set display
			}
	}

///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
// MISC
///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

function QmediaEventHandler(e)										// ON MESSAGE EVENT
{
	var v=e.data.split("|");											// Get parts
	if (v[0] == "QmediaAssess=answer")									// Answer
		SaveEvent(curTime,"Assess",assessNum++,v[3]);					// Save answer
	if (v[0] == "QmediaAssess=done")									// Done 
		DonePanel();													// Show done panel
}	

function GetTimeOnTask()											// ASK USER FOR TIME ON TASK
{
	var i;
	$("#alertBoxDiv").remove();											// Remove any old ones
	$("body").append("<div class='qm-unselectable' id='alertBoxDiv'></div>");														
	var str="<p><img src='img/ctlogo32.png' style='vertical-align:-8px'/>&nbsp;&nbsp;";								
	str+="<span class='ct-dialogTitle'>What percentage of students are OFF Task?</span><p>";
	str+="<div style='font-size:12px;margin:14px;text-align:center'><br><br>";
	for (i=0;i<110;i+=10) {												// Make 10 categories
		str+="<div id='tot-"+i+"' style='width:200px;background-color:rgb(0,"+(75+Math.floor(i*1.4))+",0);margin-bottom:4px;' class='ct-obsNewPrac'>"+i+" percent";
			if (kidsInClass) 											// If setting kids
				str+="&nbsp&nbsp;-&nbsp&nbsp;"+Math.round(i/100*kidsInClass)+" students";
		str+="</div><br>";
		}
	str+="<br><div id='tot-999' style='width:120px;background-color:#e67e22;margin-bottom:4px;' class='ct-obsNewPrac'>Skip</div>"
	str+="</div>";
	$("#alertBoxDiv").append(str);	
	$("#alertBoxDiv").dialog({ 	 width:$("#obsPanel").width()+16, height:$("#obsPanel").height()+24 });	
	$("#alertBoxDiv").dialog("option","position",{ my:"middle", at:"middle", of:obsPanel });
	
	$("[id^=tot-]").on("click", function(e) {							// ON PERCENTAGE PICK	
		var id=e.currentTarget.id.substr(4);							// Get id			
		if (id != 999)													// If not skipping
			SaveEvent(curTime,"Student status","Percent engaged",100-id);	// Save event
		$("#alertBoxDiv").remove();  									// Close it
		});
}

///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
// DONE
///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

	function DonePanel()
	{
		clearInterval(timingInterval);									// Clear timer
		clearInterval(totInterval);										// Clear tot timer
		$("#obsPanel").animate({ opacity:0 },0);						// Hide
		var str="<div class='ct-obsCat'>Save observations...</div><br><br>";
		str+="<div id='dataPanel' class='ct-dataPanel'></div><br>";
		str+="<a href='https://docs.google.com/document/d/19l87L5sZfLohU6rhQKLMERTNHhQr-jLiE4xQJeYN_3g/edit?usp=sharing' target='_blank'>";
		str+="<img src='img/helpicon.gif' style='vertical-align:bottom' title='Show help'></a>";
		str+="&nbsp; Click on a line to edit.";
		str+="<div id='saveDB' class='ct-obsNewPrac' style='float:right;margin-left:8px;'>Save session to database</div>";
		str+="<div id='saveCSV' class='ct-obsNewPrac' style='float:right'>Save CSV to computer</div><br>";
		$("#obsPanel").html(str);										// Draw panel

		var i,j,n,c;
		var now1=curTime,now2=curTime,now3=curTime,now4=curTime,now5=curTime;	// Start at end
		for (j=obsEvents.length-1;j>=0;--j) {							// Search backwards to set dur
			if (obsEvents[j].d1 == "Student actions") {					// Found a student action
				obsEvents[j].d5=now1-obsEvents[j].time;					// Add time	
				now1=obsEvents[j].time;									// New now
				}
			else if (obsEvents[j].d1 == "Vocab Word") {					// Found a vocab
				if (!obsEvents[j].d5) 									// If not ended
					obsEvents[j].d5=curTime-obsEvents[j].time;			// End it
				}
			else if (obsEvents[j].d1 == "Visual Aid") {					// Found a visual ais
				if (!obsEvents[j].d5) 									// If not ended
					obsEvents[j].d5=curTime-obsEvents[j].time;			// End it
				}
			else if (obsEvents[j].d1 == "Practice") {					// Found a practice
				obsEvents[j].d5=now2-obsEvents[j].time;					// Add time	
				now2=obsEvents[j].time;									// New now
				c=0;	n=0;											// Reset count
				for (i=j+1;i<obsEvents.length;++i) {					// Look for subs
					if (obsEvents[i].d1 == "Practice")					// If into another practice
						break;											// Quit
					if  (obsEvents[i].d1 == "Teacher actions")	{		// Found one
						n=obsEvents[i].d5;								// Get count
						++c;											// Add to count
						}
					}
				if (n)													// If subs
					obsEvents[j].d4=Math.round(c/n*100);				// Set percentage
				else													// No subs	
					obsEvents[j].d4=0;									// Set to 0
				}
			else if (obsEvents[j].d2 == "Which Teacher") {				// Found a which action
				obsEvents[j].d5=now3-obsEvents[j].time;					// Add time	
				now3=obsEvents[j].time;									// New now
				}
			else if (obsEvents[j].d2 == "Grouping") {					// Found a group action
				obsEvents[j].d5=now4-obsEvents[j].time;					// Add time	
				now4=obsEvents[j].time;									// New now
				}
			else if (obsEvents[j].d2 == "Model") {						// Found a model action
				obsEvents[j].d5=now5-obsEvents[j].time;					// Add time	
				now5=obsEvents[j].time;									// New now
				}
		}
	
		ShowRawData();													// Fill in data table
		$("#obsPanel").animate({ opacity:1 },400);						// Show end panel
	
		$("#saveDB").on("click", function() {							// ON SAVE TO DB
			SaveData();													// Save to DB
		}	);

		$("#saveCSV").on("click", function() {							// ON SAVE TO DISK
			SaveCSV();													// Save to DB
		}	);
	}

	function Assess()
	{
		var i,str="assess.htm?";
		for (i=0;i<assessData.length;++i) {								// For each assessment page
			str+=encodeURI(assessData[i]);								// Add it and encode
			if (i != assessData.length-1)								// If not last
				str+="~~";												// Add separator
			}
			
		var	str="<iframe id='assess' class='ct-assess' frameborder='0' src='"+str+"' style='height:400px;width:100%'></iframe></div>";	// Load in iframe
		$("#obsPanel").animate({ opacity:1 },400);						// Show
		$("#obsPanel").html(str);
	}

	function ShowRawData()											// SHOW RAW DATA
	{
		var i,col;
		var str="<table id='dataTable'>"
		str+="<tr id='od-name'><td><b>Observer</b></td><td>"+obsData.name+"<td></tr>";
		str+="<tr id='od-email'><td><b>Email</b></td><td>"+obsData.email+"<td></tr>";
		str+="<tr id='od-tid'><td><b>Teacher Id&nbsp;&nbsp</b></td><td>"+obsData.tid+"<td></tr>";
		str+="<tr id='od-grade'><td><b>Grade</b></td><td>"+obsData.grade+"<td></tr>";
		str+="<tr id='od-subject'><td><b>Subject:</b></td><td>"+obsData.subject+"<td></tr>";
		str+="<tr id='od-date'><td><b>Date</b></td><td>"+obsData.date+"<td></tr>";
		str+="<tr id='od-block'><td><b>Block</b></td><td>"+obsData.block+"<td></tr>";
		str+="<tr id='od-setting'><td><b>Setting</b></td><td>"+obsData.setting+"<td></tr>";
		str+="<tr id='od-video'><td><b>Video</b></td><td>"+obsData.video+"<td></tr>";
		str+="<tr><td><b>Reminder</b></td><td>"+obsData.remind+"<td></tr>";
		str+="<tr><td><b>Research</b></td><td>"+obsData.research+"<td></tr>";
		str+"<br>";

		var d=obsEvents;
		for (i=0;i<d.length;++i){
			col=(d[i].d1 == "Practice") ? "#990000" : "#000";			// Color practices 
			str+="<tr style='color:"+col+"' id=oe-"+i+"><td><b>Event</b></td><td style='overflow:hidden;white-space:nowrap'><div style='display:inline-block;width:40px'>"+d[i].time+"</div><b>";
				str+=d[i].d1+"</b>,"+ShortenString(d[i].d2,20)+","+ShortenString(d[i].d3,20)+","+ShortenString(d[i].d4,20)+","+d[i].d5+"</td></tr>";
			}	
		str+="</table>";
		$("#dataPanel").html(str);										// Add to data panel										
	
		$("[id^=od-]").on("click", function(e) {						// ON OBSDATA CLICK					
			var id=e.currentTarget.id.substr(3);						// Get id
			var str="Type new value for <b><i>"+id+"</b></i> entry";	// Prompt
			GetTextBox("Change value", str ,obsData[id], function(s) {	// Open editor
				obsData[id]=s;											// Set new val
				Sound("ding");											// Ding sound
				ShowRawData();											// Refresh screen
				});
			})
		
		$("[id^=oe-]").on("click", function(e) {						// ON OBSDATA CLICK					
			var id=e.currentTarget.id.substr(3);						// Get id
			var str="Type new value for event entry. Make sure you have 6 entries, separated by commas. They can be blank, if needed. If you want to remove the event, clear all the text.";	// Prompt
			var d=obsEvents[id].time+","+obsEvents[id].d1+","+obsEvents[id].d2+","+obsEvents[id].d3+","+obsEvents[id].d4+","+obsEvents[id].d5;								
			
			GetTextBox("Change Event", str ,d, function(s) {			// Open editor
				if (!s) {												// Nothing there
					obsEvents.splice(id,1);								// Remove it
					Sound("delete");									// Delete sound
					ShowRawData();										// Refresh screen
					return;												// Quit	
					}
				s=s.split(",");											// Divide into parts
				if (s.length < 6)		return;							// Not right number
				obsEvents[id].time=s[0];								// Set new vals
				obsEvents[id].d1=s[1];								
				obsEvents[id].d2=s[2];								
				obsEvents[id].d3=s[3];								
				obsEvents[id].d4=s[4];								
				obsEvents[id].d5=s[5];								
				Sound("ding");											// Ding sound
				ShowRawData();											// Refresh screen
				});

			});
}

	function SaveCSV() 
	{
		GetTextBox("Save as CSV File","Type name of CSV file to save to","mysession.csv", function(s) {
			var i,o;
			var rows=[["time","type","d1","d2","d3","duration"]];
			rows.push(["0","Session","Observer",obsData.name,""]);
			rows.push(["0","Session","Email",obsData.email,""]);
			rows.push(["0","Session","TeacherId",obsData.tid,""]);
			rows.push(["0","Session","Grade",obsData.grade,""]);
			rows.push(["0","Session","Subject",obsData.subject,""]);
			rows.push(["0","Session","Date",obsData.date,""]);
			rows.push(["0","Session","Block",obsData.block,""]);
			rows.push(["0","Session","Setting",obsData.setting,""]);
			rows.push(["0","Session","Level",obsData.level,""]);
			rows.push(["0","Session","NumStudents",obsData.number,""]);
			rows.push(["0","Session","Video",obsData.video,""]);
			rows.push(["0","Session","Reminder",obsData.remind,""]);
			rows.push(["0","Session","Research",obsData.research,""]);
			for (i=0;i<obsEvents.length;++i) {
				o=obsEvents[i];
				rows.push([o.time,o.d1,o.d2,o.d3,o.d4,o.d5]);
				}
			ExportToCSV(s,rows);
			})
	}

	function SaveData() 
	{
		var dat={ teacherId:obsData.tid, obs:obsData.name, 	    email:obsData.email,
				  grade:obsData.grade, subject:obsData.subject, numStudents:obsData.number,
				  date:obsData.date,   block:obsData.block,	    setting:obsData.setting, 
				  level:obsData.level, video:obsData.video,		remind:obsData.remind, 
				  research:obsData.research,				  	events: JSON.stringify(obsEvents)
				  };

		var url="//classroomteachingscan.com/ctscan/saveobs.php";		// Target
		$.ajax({ url:url,dataType:'text',type:"POST",crossDomain:true,data:dat,  // Post data
			success:function(d) { 			
				if (isNaN(d)) {											// Error
					Sound("delete");									// Delete sound
					trace(d);											// Show error
					}
				else{
					AlertBox("Successfully saved!","");					// Alert
					$("#saveDB").remove();								// Remove save button
					}
				},
			error:function(xhr,status,error) { trace(error) },			// Show error
			});		
	}


////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
// HELPERS
////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
	
	function ShowPopup(x, y, msg)										// SHOW A POPUP
	{
		if (!msg)															// Nothing to show
			return;															// Quit
		$("#popup").css({left:x,top:y});									// Position
		$("#popup").html(msg);												// Add text										
		$("#popup").show();													// Show it
		$("#popup").delay(2000).fadeOut(400);								// Close after 4 seconds
		}

	
	function SaveEvent(time, p1, p2, p3, p4, p5)
	{
		if (p3 == undefined)	p3="";
		if (p4 == undefined)	p4="";
		if (p5 == undefined)	p5="";
		trace(time+","+p1+","+p2+","+p3+","+p4+","+p5);						// Show data
		obsEvents.push({time:time, d1:p1, d2:p2, d3:p3, d4:p4, d5:p5 });	// Save in array
	}

	function ExportToCSV(filename, rows) {
 	    var processRow = function (row) {
            var finalVal = '';
            for (var j = 0; j < row.length; j++) {
                var innerValue = row[j] === null ? '' : row[j].toString();
                if (row[j] instanceof Date) {
                    innerValue = row[j].toLocaleString();
                };
                var result = innerValue.replace(/"/g, '""');
                if (result.search(/("|,|\n)/g) >= 0)
                    result = '"' + result + '"';
                if (j > 0)
                    finalVal += ',';
                finalVal += result;
            }
            return finalVal + '\n';
        };

        var csvFile = '';
        for (var i=0; i<rows.length;i++)
            csvFile+=processRow(rows[i]);
    
	    var blob = new Blob([csvFile], { type: 'text/csv;charset=utf-8;' });
        if (navigator.msSaveBlob) { // IE 10+
            navigator.msSaveBlob(blob, filename);
        } else {
            var link = document.createElement("a");
    		    if (link.download !== undefined) { 							// Browsers that support HTML5 download attribute
					var url = URL.createObjectURL(blob);
					link.setAttribute("href", url);
					link.setAttribute("download", filename);
					link.style.visibility = 'hidden';
					document.body.appendChild(link);
					link.click();
					document.body.removeChild(link);
					}
				}
    }

	function ConfirmBox(content, callback)								// CONFIRMATION BOX
	{
		Sound("ding");														// Ding sound
		$("#confirmBoxDiv").remove();										// Remove 
		$("body").append("<div class='unselectable' id='confirmBoxDiv'></div>");														
		var str="<p><img src='img/ctlogo32.png' style='vertical-align:-10px'/>&nbsp;&nbsp;";								
		str+="<span style='font-size:18px;text-shadow:1px 1px #ccc;color:#666'><b>Are you sure?</b></span><p>";
		str+="<div style='font-size:14px;margin:14px'>"
		str+=content;
		str+="<br><br><div id='confirmOK' class='ct-obsNewPrac'>OK</div>";
		str+="<div id='confirmCancel' class='ct-obsNewPrac' style='margin-left:8px;background-color:#e74c3c'>Cancel</div></div>";
		$("#confirmBoxDiv").append(str);	
		$("#confirmBoxDiv").dialog({ width:350});	
		$("#confirmBoxDiv").dialog("option","position",{ my:"center", at:"center", of:obsPanel });
		$("#confirmBoxDiv").css({ border:"1px solid #009900","border-radius":"6px"});

		$("#confirmOK").on("click", function() {							// ON OK BUT
				$("#confirmBoxDiv").remove();								// Remove 
				if (callback)	callback();									// If callback defines, run it
				});

		$("#confirmCancel").on("click", function() {						// ON cancel BUT
				$("#confirmBoxDiv").remove();								// Remove 
				Sound("delete");											// Delete sound
			});
	}

	function AlertBox(title, content, callback)							// ALERT BOX
	{
		Sound("ding");														// Ding sound
		$("#alertBoxDiv").remove();											// Remove any old ones
		$("body").append("<div class='unselectable' id='alertBoxDiv'></div>");														
			var str="<p><img src='img/ctlogo32.png' style='vertical-align:-10px'/>&nbsp;&nbsp;";								
			str+="<span style='font-size:18px;text-shadow:1px 1px #ccc;color:#666'><b>"+title+"</b></span><p>";
			str+="<div id='alertOK' class='ct-obsNewPrac' style='margin-left:46px;'>OK</div>";
			str+="<div style='font-size:14px;margin:14px;'>"+content+"</div>";
			$("#alertBoxDiv").append(str);	
			$("#alertBoxDiv").dialog({ width:350 });	
			$("#alertBoxDiv").dialog("option","position",{ my:"center", at:"center", of:obsPanel });
			$("#alertBoxDiv").css({ border:"1px solid #e74c3c","border-radius":"6px"});
		
			$("#alertOK").on("click", function() {							// ON OK BUT
				if (callback)	callback();									// Run callback
				$("#alertBoxDiv").remove();									// Remove alert
				});
		}

	function DialogBox(title, content, callback, callback2) 		// DIALOG BOX
	{
		$("#dialogDiv").remove();												
		$("body").append("<div class='unselectable' id='dialogDiv'></div>");														
		var str="<p><img src='img/ctlogo32.png' style='vertical-align:-8px'/>&nbsp;&nbsp;";								
		str+="<span class='ct-dialogTitle'>"+title+"</span><p>";
		str+="<div style='font-size:12px;margin:14px'>";
		str+=content;
		str+="<br><br><div id='dialogOK' class='ct-obsNewPrac'>OK</div>";
		str+="<div id='dialogCancel' class='ct-obsNewPrac' style='margin-left:8px;background-color:#e74c3c'>Cancel</div></div>";
		$("#dialogDiv").append(str);	
		$("#dialogDiv").dialog({ width:$("#obsPanel").width()+16, height:$("#obsPanel").height()+24 });
		$("#dialogDiv").dialog("option","position",{ my:"left top", at:"left top", of:obsPanel });

		$("#dialogOK").on("click", function() {							// ON OK BUT
				if (callback)	callback();								// If callback defined
				$("#dialogDiv").animate({ opacity:0},200, function() {		
					$("#dialogDiv").remove();  
					});
				});

		$("#dialogCancel").on("click", function() {						// ON CANCEL BUT
				$("#dialogBoxDiv").remove();							// Remove 
				if (callback2)	callback2();							// If callback defined, run it
				$("#dialogDiv").animate({ opacity:0},200, function() {		
					$("#dialogDiv").remove();  
					});
				Sound("delete");										// Delete sound
			});

	}

	function GetTextBox(title, content, def, callback)					// GET TEXT LINE BOX
	{
		$("#alertBoxDiv").remove();											// Remove any old ones
		$("body").append("<div class='qm-unselectable' id='alertBoxDiv'></div>");														
		var str="<p><img src='img/ctlogo32.png' style='vertical-align:-8px'/>&nbsp;&nbsp;";								
		str+="<span class='ct-dialogTitle'>"+title+"</span><p>";
		str+="<div style='font-size:12px;margin:14px'>"+content;
		str+="<p><input class='ct-is' type='text' style='width:425px' id='gtBoxTt' value='"+def+"'></p>";
		str+="<div id='dialogOK' class='ct-obsNewPrac'>OK</div>";
		str+="<div id='dialogCancel' class='ct-obsNewPrac' style='margin-left:8px;background-color:#e74c3c'>Cancel</div></div>";
		
		$("#alertBoxDiv").append(str);	
		$("#alertBoxDiv").dialog({ width:500 });	
		$("#alertBoxDiv").dialog("option","position",{ my:"center", at:"center", of:obsPanel });
		$("#alertBoxDiv").css({ border:"1px solid #009900","border-radius":"6px"});

		$("#dialogOK").on("click", function() {							// ON OK BUT
					callback($("#gtBoxTt").val());
					$("#alertBoxDiv").remove();  
				});

		$("#dialogCancel").on("click", function() {						// ON CANCEL BUT
				$("#alertBoxDiv").remove();								// Remove 
				Sound("delete");										// Delete sound
			});

		}

	function trace(msg, p1, p2, p3, p4)										// CONSOLE 
	{
		if (p4 != undefined)
			console.log(msg,p1,p2,p3,p4);
		else if (p3 != undefined)
			console.log(msg,p1,p2,p3);
		else if (p2 != undefined)
			console.log(msg,p1,p2);
		else if (p1 != undefined)
			console.log(msg,p1);
		else
			console.log(msg);
	}

	function ShortenString(str, len)									// SHORTEN A STRING TO LENGTH
	{
		if (str && str.length > len)										// Too long
			str=str.substr(0,(len-3)/2)+"..."+str.slice((len-3)/-2);		// Shorten	
		return str;															// Return string
	}

	function Sound(sound, mute)												// PLAY SOUND
	{
		var snd=new Audio();													// Init audio object
		if (!snd.canPlayType("audio/mpeg") || (snd.canPlayType("audio/mpeg") == "maybe")) 
			snd=new Audio("img/"+sound+".ogg");									// Use ogg
		else	
			snd=new Audio("img/"+sound+".mp3");									// Use mp3
		if (!mute)	{															// If not initing or muting	
			snd.volume=50/100;													// Set volume
			snd.play();															// Play it
			}
		}

</script>
</body>
</html>
